<!DOCTYPE html>
<html>
<head>
    <title>GeoPort Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <!-- LeafletJS –¥–ª—è –∫–∞—Ä—Ç—ã -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --tg-bg-color: var(--tg-theme-bg-color, #ffffff);
            --tg-text-color: var(--tg-theme-text-color, #000000);
            --tg-hint-color: var(--tg-theme-hint-color, #888888);
            --tg-button-color: var(--tg-theme-button-color, #007bff);
            --tg-button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        body {
            margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-bg-color); color: var(--tg-text-color);
            display: flex; flex-direction: column; height: 100vh;
        }
        #map { flex-grow: 1; }
        .controls { padding: 10px; background-color: var(--tg-secondary-bg-color); display: flex; flex-direction: column; gap: 10px; border-top: 1px solid var(--tg-hint-color); }
        .search-container { display: flex; gap: 5px; }
        #address-input { flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid var(--tg-hint-color); }
        .button { padding: 10px 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; width: 100%; }
        #search-button { width: auto; background-color: var(--tg-button-color); color: var(--tg-button-text-color); }
        #set-location-button { background-color: var(--tg-button-color); color: var(--tg-button-text-color); }
        #add-favorite-button { background-color: #28a745; color: #ffffff; }
        #status { font-size: 12px; text-align: center; color: var(--tg-hint-color); padding-top: 5px; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div class="controls">
        <div class="search-container">
            <input type="text" id="address-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞...">
            <button id="search-button" class="button">üîç</button>
        </div>
        <button id="set-location-button" class="button">üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç—É –ª–æ–∫–∞—Ü–∏—é</button>
        <button id="add-favorite-button" class="button">‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
        <div id="status">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); 

        let selectedLat = 55.7558; // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ú–æ—Å–∫–≤–∞)
        let selectedLon = 37.6173;
        let marker = null;

        const map = L.map('map').setView([selectedLat, selectedLon], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        function updateMarker(lat, lon, shouldPan = true) {
            selectedLat = lat;
            selectedLon = lon;
            
            if (marker) {
                marker.setLatLng([lat, lon]);
            } else {
                marker = L.marker([lat, lon]).addTo(map);
            }
            
            if (shouldPan) map.panTo([lat, lon]);

            document.getElementById('status').innerText = `–í—ã–±—Ä–∞–Ω–æ: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
        }

        map.on('click', (e) => updateMarker(e.latlng.lat, e.latlng.lng));

        document.getElementById('search-button').addEventListener('click', async () => {
            const address = document.getElementById('address-input').value;
            if (!address) return;
            document.getElementById('status').innerText = '–ò–¥–µ—Ç –ø–æ–∏—Å–∫...';
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
                const data = await response.json();
                if (data && data.length > 0) {
                    updateMarker(parseFloat(data[0].lat), parseFloat(data[0].lon));
                } else {
                    tg.showAlert('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.');
                    document.getElementById('status').innerText = '–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                }
            } catch (error) {
                tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∞–¥—Ä–µ—Å–∞.');
            }
        });
        
        document.getElementById('set-location-button').addEventListener('click', () => {
            const data = { action: 'set_location', lat: selectedLat, lon: selectedLon };
            tg.sendData(JSON.stringify(data));
        });

        document.getElementById('add-favorite-button').addEventListener('click', () => {
            tg.showPopup({
                title: '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ',
                message: '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è —ç—Ç–æ–π –ª–æ–∫–∞—Ü–∏–∏:',
                buttons: [{ id: 'save', type: 'default', text: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' }, { type: 'cancel' }]
            }, (buttonId) => {
                // –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ Telegram –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–ª–µ –≤–≤–æ–¥–∞,
                // –ø–æ—ç—Ç–æ–º—É –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π prompt, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–≥–ª—è–¥–∏—Ç –Ω–µ —Ç–∞–∫ –∫—Ä–∞—Å–∏–≤–æ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.
                if (buttonId === 'save') {
                    const favName = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:", `–ò–∑–±—Ä–∞–Ω–Ω–æ–µ`);
                    if (favName) {
                         const data = { action: 'add_favorite', name: favName, lat: selectedLat, lon: selectedLon };
                         tg.sendData(JSON.stringify(data));
                    }
                }
            });
        });

        updateMarker(selectedLat, selectedLon, false);
        tg.ready();
    </script>
</body>
</html>
