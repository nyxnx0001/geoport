<!DOCTYPE html>
<html>
<head>
    <title>GeoPort Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <!-- –°—Ç–∏–ª–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã –∫–∞—Ä—Ç—ã (Leaflet) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- –°–∫—Ä–∏–ø—Ç Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; }
        #map { flex-grow: 1; }
        .controls { 
            padding: 10px; 
            background: #f0f0f0; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            border-top: 1px solid #ccc;
        }
        .search-box { display: flex; gap: 5px; }
        input { flex: 1; padding: 8px; border: 1px solid #999; border-radius: 4px; }
        button { 
            padding: 10px; 
            border: none; 
            border-radius: 4px; 
            background: #3390ec; 
            color: white; 
            font-size: 16px; 
            cursor: pointer; 
        }
        button:active { opacity: 0.8; }
        #add-fav { background: #28a745; }
        #status { text-align: center; font-size: 12px; color: #555; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="controls">
        <div class="search-box">
            <input type="text" id="address" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å...">
            <button id="btn-search">üîç</button>
        </div>
        <button id="btn-set">üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</button>
        <button id="add-fav">‚≠ê –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
        <div id="status">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞—Å–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å (–î–õ–Ø –û–¢–õ–ê–î–ö–ò)
        tg.showAlert("–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞! Ver 2.0");

        // –ù–∞—á–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–ú–æ—Å–∫–≤–∞)
        let curLat = 55.7558;
        let curLon = 37.6173;
        let marker = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const map = L.map('map').setView([curLat, curLon], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
        function setMarker(lat, lon) {
            curLat = lat;
            curLon = lon;
            if (marker) {
                marker.setLatLng([lat, lon]);
            } else {
                marker = L.marker([lat, lon]).addTo(map);
            }
            map.panTo([lat, lon]);
            document.getElementById('status').innerText = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
        }

        // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
        map.on('click', (e) => {
            setMarker(e.latlng.lat, e.latlng.lng);
        });

        // –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞
        document.getElementById('btn-search').addEventListener('click', async () => {
            const query = document.getElementById('address').value;
            if(!query) return;
            document.getElementById('status').innerText = "–ò—â—É...";
            try {
                const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await resp.json();
                if(data && data.length > 0) {
                    setMarker(parseFloat(data[0].lat), parseFloat(data[0].lon));
                } else {
                    tg.showAlert("–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω");
                }
            } catch(e) {
                tg.showAlert("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞");
            }
        });

        // --- –ì–õ–ê–í–ù–ê–Ø –ö–ù–û–ü–ö–ê: –£–°–¢–ê–ù–û–í–ò–¢–¨ –õ–û–ö–ê–¶–ò–Æ ---
        document.getElementById('btn-set').addEventListener('click', () => {
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            const dataToSend = {
                action: 'set_location',
                lat: curLat,
                lon: curLon
            };
            
            // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ —Å—Ç—Ä–æ–∫—É JSON
            const jsonString = JSON.stringify(dataToSend);

            // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–∫—É (–ß–¢–û–ë–´ –í–´ –í–ò–î–ï–õ–ò, –ß–¢–û –ù–ê–ñ–ê–õ–û–°–¨)
            tg.showAlert("–û—Ç–ø—Ä–∞–≤–ª—è—é –±–æ—Ç—É:\n" + jsonString);

            // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–æ—Ç—É
            tg.sendData(jsonString);
        });

        // –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        document.getElementById('add-fav').addEventListener('click', () => {
            const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏:", "–î–æ–º");
            if(name) {
                const data = {
                    action: 'add_favorite',
                    name: name,
                    lat: curLat,
                    lon: curLon
                };
                tg.sendData(JSON.stringify(data));
            }
        });

        // –°—Ç–∞–≤–∏–º –Ω–∞—á–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä
        setMarker(curLat, curLon);

    </script>
</body>
</html>
