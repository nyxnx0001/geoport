<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>GeoPort</title>

    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

    <!-- Leaflet -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f4f4f4;
        }

        #map {
            flex: 1;
        }

        .panel {
            padding: 10px;
            background: #ffffff;
            border-top: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .row {
            display: flex;
            gap: 6px;
        }

        input, select {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        button {
            padding: 10px;
            border-radius: 6px;
            border: none;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }

        .primary { background: #3390ec; color: white; }
        .success { background: #28a745; color: white; }
        .secondary { background: #6c757d; color: white; }

        #status {
            font-size: 12px;
            text-align: center;
            color: #555;
        }
    </style>
</head>

<body>

<div id="map"></div>

<div class="panel">
    <!-- –ü–æ–∏—Å–∫ -->
    <div class="row">
        <input id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É..." />
        <button class="secondary" onclick="searchAddress()">üîç</button>
    </div>

    <!-- –ò–∑–±—Ä–∞–Ω–Ω—ã–µ -->
    <div class="row">
        <select id="favorites" onchange="selectFavorite()">
            <option value="">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞</option>
        </select>
        <button class="success" onclick="addFavorite()">Ôºã</button>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <button class="primary" onclick="sendLocation()">üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–µ–π–∫-–ª–æ–∫–∞—Ü–∏—é</button>

    <div id="status">–õ–æ–∫–∞—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // ------------------ –°–û–°–¢–û–Ø–ù–ò–ï ------------------
    let currentLat = 55.7558;
    let currentLon = 37.6173;

    // ------------------ –ö–ê–†–¢–ê ------------------
    const map = L.map('map').setView([currentLat, currentLon], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    const marker = L.marker([currentLat, currentLon]).addTo(map);

    function updateMarker(lat, lon) {
        currentLat = lat;
        currentLon = lon;
        marker.setLatLng([lat, lon]);
        map.panTo([lat, lon]);
        updateStatus();
    }

    map.on('click', e => {
        updateMarker(e.latlng.lat, e.latlng.lng);
    });

    // ------------------ –°–¢–ê–¢–£–° ------------------
    function updateStatus() {
        document.getElementById("status").innerText =
            `–§–µ–π–∫-–ª–æ–∫–∞—Ü–∏—è: ${currentLat.toFixed(5)}, ${currentLon.toFixed(5)}`;
    }

    // ------------------ –ü–û–ò–°–ö ------------------
    async function searchAddress() {
        const q = document.getElementById("search").value.trim();
        if (!q) return;

        document.getElementById("status").innerText = "–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞...";

        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.length === 0) {
            tg.showAlert("–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω");
            return;
        }

        updateMarker(parseFloat(data[0].lat), parseFloat(data[0].lon));
    }

    // ------------------ –û–¢–ü–†–ê–í–ö–ê –ë–û–¢–£ ------------------
    function sendLocation() {
        const payload = {
            action: "set_location",
            lat: currentLat,
            lon: currentLon
        };

        tg.sendData(JSON.stringify(payload));
    }

    // ------------------ –ò–ó–ë–†–ê–ù–ù–´–ï ------------------
    function loadFavorites() {
        const favs = JSON.parse(localStorage.getItem("favorites") || "[]");
        const select = document.getElementById("favorites");

        select.innerHTML = '<option value="">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞</option>';
        favs.forEach((f, i) => {
            const opt = document.createElement("option");
            opt.value = i;
            opt.textContent = f.name;
            select.appendChild(opt);
        });
    }

    function addFavorite() {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞:");
        if (!name) return;

        const favs = JSON.parse(localStorage.getItem("favorites") || "[]");
        favs.push({
            name,
            lat: currentLat,
            lon: currentLon
        });

        localStorage.setItem("favorites", JSON.stringify(favs));
        loadFavorites();
    }

    function selectFavorite() {
        const idx = document.getElementById("favorites").value;
        if (idx === "") return;

        const favs = JSON.parse(localStorage.getItem("favorites"));
        const f = favs[idx];
        updateMarker(f.lat, f.lon);
    }

    // ------------------ INIT ------------------
    loadFavorites();
    updateStatus();
</script>

</body>
</html>
